# KMS

## **Purpose and Goals of KMS**

- Easily control access to data through encryption.
- AWS manages the encryption keys.
- Fully integrated with IAM for authorization.
- Seamless integration with various AWS services (EBS, S3, Redshift, RDS, SSM, etc.).
- Interact with KMS using CLI or SDK.

## **Types of KMS Keys**

### **1. Symmetric Keys**

- Single key for both encryption and decryption.
- First offering of KMS.
- Used by all AWS services integrated with KMS.
- Required for envelope encryption.
- You never get access to the unencrypted KMS key; you must use KMS API calls.

### **2. Asymmetric Keys**

- Public-private key pair.
- Public key for encryption, private key for decryption.
- Supports encrypt/decrypt and sign/verify operations.
- Public key can be downloaded for encryption in untrusted environments.
- Only the private key can decrypt data encrypted with the public key.
- Private key cannot be accessed unencrypted; KMS API calls are required.
- **Use Case:** Encryption outside of AWS by users who cannot directly call the KMS API.

## **Types of KMS Keys (Management Perspective)**

### **1. Customer-Managed Keys (CMK)**

- Created directly in KMS by the user.
- User has full control: create, manage, use, enable/disable.
- Rotation policy can be enabled (automatic yearly rotation, old key preserved).
- Key policy (resource policy for the KMS key) can be added.
- Key usage can be audited in CloudTrail.
- Leveraged for envelope encryption.
- Managed by the customer.

### **2. AWS-Managed Keys**

- Used exclusively by AWS services (e.g., aws/s3, aws/ebs).
- Visible in the AWS console when using AWS-managed encryption.
- Managed by AWS.
- Automatically rotated annually.
- Key policy can be viewed, and usage can be audited in CloudTrail.
- Cannot be used for custom encryption operations.

### **3. AWS-Owned Keys**

- Created and managed by AWS.
- Used by some services to protect resources.
- Can be used across multiple AWS accounts (internally by AWS).
- Not in your AWS account.
- Cannot be viewed, used, tracked, or audited by the user.
- AWS informs you that these keys exist.

## **Summary of Key Management Types**

| **Feature** | **Customer-Managed Keys** | **AWS-Managed Keys** | **AWS-Owned Keys** |
| --- | --- | --- | --- |
| Metadata View | Yes | Yes | No |
| Key Management | User | AWS | AWS |
| Account Usage | Your account(s) | Your account(s) | Across multiple accounts |
| Automatic Rotation | Configurable (default 1 year), on-demand | Yes (1 year) | Yes (internal to AWS) |
| Trigger Rotation | Yes | No | No |
| Access/Visibility | Full | View policy, audit | None |

## **Creating a KMS Key: Key Material Origin**

- Cannot be changed after creation; must be defined at creation time.

### **1. KMS**

- KMS automatically creates, generates, and manages the key within its own key store.
- Standard way to create KMS keys.

### **2. External**

- You import the key material directly into the KMS key.
- You are responsible for securing and managing the key material outside of AWS.
- Can create externally and import, or maintain a copy outside of KMS.

### **3. AWS_CLOUDHSM (Custom Key Store)**

- Create key material directly within your dedicated HSM cluster managed by AWS CloudHSM.
- Direct integration between CloudHSM and KMS.
- Key materials are stored within your HSM cluster.
- Keys are managed and used by KMS.
- Cryptographic operations are performed within the HSMs.
- **Architecture:** CloudHSM cluster (minimum 2 AZs for HA) directly connected to KMS. Users interact with KMS API.
- **Use Cases:** Direct control over HSMs for higher security or compliance requirements to store KMS keys in a dedicated HSM environment.

## **External KMS Key Source (Bring Your Own Key - BYOK)**

- You are responsible for the key material's security, availability, and durability outside of AWS.
- Supports both symmetric and asymmetric KMS key material.
- Cannot be used with custom key stores; it's a standalone option.
- Automated rotation is not supported; you must manage rotation manually.

### **Process to Import External Keys**

1. Create a KMS key in KMS with the source as "External."
2. KMS creates the key envelope but without the key material.
3. Download the public key and an import token from KMS.
4. Use the public key to encrypt your externally generated key material.
5. Send the encrypted key material back to the KMS service using the import token.
6. KMS decrypts the key material and stores it within the KMS key.

## **KMS Multi-Region Keys**

- Create a primary key in one region (e.g., US East 1) and replicate it to other regions.
- Replicated keys have the same key material and the same key ID across regions.
- **Benefits:**
    - Encrypt in one region and decrypt in another using the same KMS key ID.
    - Avoid re-encrypting data for use in different regions.
    - Eliminate the need for cross-region KMS API calls for decryption.
- Same key ID, key material, and automatic rotation policy across replicas.
- **Not Global Keys:** There is a primary key and replica keys.
- Each key can be managed independently.
- A replica key can be promoted to become a new primary key.
- **Use Cases:**
    - Disaster Recovery (DR) scenarios.
    - Global data management (e.g., DynamoDB Global Tables).
    - Active-active applications spanning multiple regions.
    - Distributing signing applications.