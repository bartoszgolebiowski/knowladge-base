# CloudFront

# AWS Solution Architect Professional - Amazon CloudFront Notes

## Overview of Amazon CloudFront

- Content Delivery Network (CDN) that improves read performance.
- Content is cached at the edge locations.
- Global network with over 200 Points of Presence (PoPs).
- Provides protection against Distributed Denial of Service (DDoS) attacks due to its distributed nature.
- Integrates with AWS Shield, AWS WAF (Web Application Firewall), and Amazon Route 53.
- Applications on CloudFront are exposed via HTTPS.
- Internally, communication with backend applications can be over HTTP or HTTPS.
- Supports the WebSocket protocol.

## How CloudFront Works

- When a user requests content:
    - The request is routed to the nearest CloudFront edge location.
    - If the content is cached at that edge location, it's served directly to the user (low latency).
    - If the content is not cached, the edge location retrieves it from the origin server.
    - The content is then cached at the edge location for subsequent requests.
- Example:
    - A website or files are deployed to an Amazon S3 bucket.
    - Users globally access this content through CloudFront.
    - A user in America accesses a local CloudFront cache, which fetches the content from S3 if it's not already cached.
    - Subsequent requests from American users are served from the cache.
    - Similarly, users in other regions access content through their nearest PoP.

## CloudFront Origins

An origin is the source location where CloudFront retrieves content. Supported origin types include:

- **Amazon S3 Bucket:**
    - Used for distributing files to the web and for uploading files to S3 via CloudFront (ingress).
    - Security is maintained using **CloudFront Origin Access Control (OAC)**, ensuring only CloudFront can access the S3 bucket content.
- **AWS MediaStore Container and MediaPackage Endpoint:**
    - Used for delivering Video on Demand (VOD) and live streaming videos using AWS Media Services.
- **VPC Origin:**
    - For applications hosted in private subnets within a Virtual Private Cloud (VPC).
    - Allows distribution of content hosted behind:
        - Application Load Balancers (ALB)
        - Network Load Balancers (NLB)
        - EC2 instances (directly)
    - Traffic to these private origins goes through a dedicated VPC Origin setup in CloudFront.
- **Custom Origin (HTTP/HTTPS based):**
    - For any publicly accessible HTTP/HTTPS backend.
    - Examples:
        - API Gateway (can also use API Gateway edge feature directly).
        - S3 bucket configured for static website hosting (requires enabling static website hosting).
        - Any public HTTP backend hosted inside or outside of AWS.

## Using S3 as an Origin

- Tight integration between CloudFront and S3 is achieved through Origin Access Control (OAC).
- Content from the S3 bucket is cached at various edge locations globally (e.g., Los Angeles, Sao Paolo, Mumbai, Melbourne).
- Requests to these edge locations are served from the cache if the content is available.
- This improves latency for users and reduces the load on the origin S3 bucket.

## CloudFront vs. S3 Cross-Region Replication

| Feature | Amazon CloudFront | S3 Cross-Region Replication |
| --- | --- | --- |
| **Network** | Global Edge Network (over 200 PoPs) | Region-specific |
| **Caching** | Files are cached with a Time-to-Live (TTL) | No inherent caching mechanism |
| **Content Type** | Great for static content available globally | Suitable for dynamic content needing low latency in a few regions |
| **Setup** | Single setup for global distribution | Requires setup for each target region |
| **Update Frequency** | Cached content updates based on TTL | Near real-time updates to replicated regions |
| **Access Type** | Read access for end users through the edge network | Read-only in the destination region |
| **Primary Use Case** | Global content delivery, improved read performance | Disaster recovery, low-latency access in specific regions |

## VPC Origin Functionality

- Allows delivering traffic directly from private subnets to CloudFront.
- Uses a "private origin" configuration.
- Supports private Application Load Balancers, Network Load Balancers, and EC2 instances as origins.
- Requires setting up a VPC Origin in CloudFront for secure connectivity.
- Considered the optimal and more secure way to serve content from private infrastructure.

## Using Public IPs and Public ARNs as Origins (Older Method)

- CloudFront can use public EC2 instances or public Application Load Balancers as origins.
- **EC2 Instance (Public):**
    - The EC2 instance must have a public IP address for edge locations to access it.
    - Security groups can be configured to allow traffic only from CloudFront's public IP ranges.
- **Application Load Balancer (Public):**
    - The ALB must be public.
    - Backend EC2 instances can be private.
    - Security group on the ALB should allow traffic from CloudFront's public IP ranges.
    - Note: Security between EC2 instances and the ALB is then managed within the VPC.

## Enhancing Security with Custom HTTP Headers

- To prevent direct access to custom origins (like ALBs or public EC2 instances), you can use custom HTTP headers.
- CloudFront adds a secret header with a secret value to every request it forwards to the origin.
- The origin (ALB or custom server) is configured to only process requests that contain this specific header and value.
- Requests without the correct header are discarded, preventing unauthorized direct access.
- This adds an extra layer of security beyond network-level restrictions.
- Network-level restrictions (security groups allowing only CloudFront IPs) can be combined with custom headers for enhanced defense-in-depth.

## Origin Groups for High Availability and Failover

- Origin groups increase application availability and provide failover capabilities.
- An origin group consists of one primary origin and one or more secondary origins.
- If the primary origin fails (based on configurable error status codes), CloudFront automatically switches traffic to a secondary origin.
- Origins within a group can be in different AWS regions, enabling cross-region disaster recovery.
- Example:
    - Primary origin in `us-east-1`.
    - Secondary origin in `eu-west-1`.
    - If the primary origin returns an error, the request is retried against the secondary origin.
- Origin groups can also be used with S3 buckets for regional high availability.
    - Requires configuring replication between the primary and secondary S3 buckets to ensure data consistency in case of failover.
    - If one bucket is unavailable, CloudFront can try the other bucket in a different region.