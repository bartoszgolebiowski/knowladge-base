# API Gateway 2

## **Usage Plans and API Keys**

- **Purpose:** Monetize and manage access to your APIs offered to customers.
- **Usage Plans:**
    - Define who can access specific API stages and methods.
    - Control the rate and volume of access for clients.
    - Associated with one or more API stages.
- **API Keys:**
    - Alphanumeric secret strings distributed to customers for identification.
    - Used in conjunction with Usage Plans to meter and measure API access.
    - Enable the enforcement of throttling and quota limits on individual clients.
- **Throttling Limits (API Key Level):** Control the number of requests a specific API key can make within a given time period.
- **Quota Limits (API Key Level):** Define the maximum total number of requests an API key can make.
- **Error Response:** Exceeding these limits results in a `429 Too Many Requests` error.
- **Account Level Throttling:** There's also an account-level throttling limit across all APIs within a specific AWS region. Exceeding this requires implementing client-side retry mechanisms with exponential backoff.

## **WebSocket APIs**

- **Two-Way Interactive Communication:** Enables persistent connections between clients (e.g., browsers) and the server.
- **Server-Initiated Push:** Allows the server to send data to clients without a prior request, facilitating stateful applications.
- **Use Cases:** Real-time applications like chat, collaboration tools, multiplayer games, and financial trading platforms.
- **Integration with AWS Services:** Works with Lambda, DynamoDB, HTTP endpoints, etc.
- **Architecture Example (Chat Application):**
    1. **Client Connection:** Clients establish a persistent WebSocket connection to the API Gateway endpoint.
    2. **`$connect` Route:** API Gateway invokes a Lambda function (e.g., `onConnect`) when a new connection is established. This function might persist the connection ID in DynamoDB.
    3. **`$message` Route:** When a client sends a message, API Gateway invokes another Lambda function (e.g., `sendMessage`) to process and persist the message (e.g., in DynamoDB).
    4. **`$disconnect` Route:** When a client disconnects, API Gateway invokes a Lambda function (e.g., `onDisconnect`) to handle cleanup (e.g., removing the connection ID from DynamoDB).
    5. **Sending Messages to Clients (`@connections`):**
        - Each persistent connection has a unique `connectionId`.
        - API Gateway provides a callback URL specific to each connection: `https://{api-id}.execute-api.{region}.amazonaws.com/@connections/{connectionId}`.
        - To send a message back to a specific client, a Lambda function (or other backend service) can `POST` data to this callback URL.
        - API Gateway intelligently routes the message to the corresponding connected client.

## **Private APIs**

- **VPC-Restricted Access:** Private API Gateway endpoints can only be accessed from within your Virtual Private Cloud (VPC) or peered VPCs. They are not accessible via the public internet.
- **VPC Interface Endpoints (Powered by PrivateLink):** To access a private API Gateway from within your VPC, you need to create VPC Interface Endpoints for `com.amazonaws.{region}.execute-api`.
- **Access Control:**
    - **VPC Endpoint Policies:** Control which principals (IAM users, roles) within your AWS account can access the Interface Endpoint itself. This is the first layer of security.
    - **API Gateway Resource Policies:** Attached to the private API Gateway, these policies allow or deny access to the API from specific VPCs and VPC Endpoints, including those in different AWS accounts. This is the second layer of security.
- **Conditions in Resource Policies:** You can use conditions like `aws:SourceVpc` and `aws:SourceVpce` in your API Gateway Resource Policy to further restrict access based on the originating VPC or VPC Endpoint.
- **Benefits:** Enhanced security for internal APIs and microservices by isolating them within your private network.

These additional concepts provide a more comprehensive understanding of how to manage access, build real-time applications, and secure your APIs using Amazon API Gateway. They are important considerations for designing robust and scalable solutions on AWS.